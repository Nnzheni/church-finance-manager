<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard â€“ AFM-RCA Financial Management System</title>

  <!-- PWA & Icons -->
  <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
  <link rel="icon" href="{{ url_for('static', filename='icons/icon-192.png') }}">
  <meta name="theme-color" content="#00466f">

  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >

  <style>
    /* Override some Bootstrap defaults for a softer look */
    body { background: #f4f6f9; }
    .card { border-radius: 0.75rem; }
    .btn-brand { 
      background: #00466f; 
      color: #fff; 
      border-radius: .5rem;
    }
    .btn-brand:hover { background: #003550; }
  </style>
</head>
<body>

  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-brand px-4">
    <a class="navbar-brand d-flex align-items-center" href="#">
      <img src="{{ url_for('static','images/logo.png') }}" height="40" class="me-2" alt="Church Logo">
      AFM-RCA Finance
    </a>
    <div class="ms-auto d-flex align-items-center">
      <span class="me-3 text-light">{{ dept }} | {{ role }}</span>
      <a href="{{ url_for('logout') }}" class="btn btn-light btn-sm">Logout</a>
    </div>
  </nav>

  <div class="container my-5">
    <!-- Header & Filters -->
    <div class="row align-items-center mb-4">
      <div class="col-md-6">
        <h3 class="mb-0">Welcome, {{ user }} ðŸ‘‹</h3>
        <small class="text-muted">Summary for {{ now.strftime('%B %Y') }}</small>
      </div>
      <div class="col-md-6 text-md-end">
        <form method="get" class="row gx-2 gy-2 justify-content-md-end">
          <div class="col-auto">
            <select name="month" class="form-select form-select-sm">
              {% for m in range(1,13) %}
              <option value="{{ m }}" {% if m==selected_month %}selected{% endif %}>{{ m }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-auto">
            <select name="year" class="form-select form-select-sm">
              {% for y in range(current_year-2, current_year+1) %}
              <option value="{{ y }}" {% if y==selected_year %}selected{% endif %}>{{ y }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-auto">
            <button class="btn btn-primary btn-sm">Apply Filters</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Action Buttons -->
    {% if role=='Finance Manager' %}
    <div class="d-flex flex-wrap gap-2 mb-4">
      <a href="{{ url_for('add_income') }}" class="btn btn-success">
        <i class="bi bi-plus-circle"></i> Add Income
      </a>
      <a href="{{ url_for('add_expense') }}" class="btn btn-danger">
        <i class="bi bi-dash-circle"></i> Add Expense
      </a>
      <a href="{{ url_for('report') }}" class="btn btn-info text-white">
        <i class="bi bi-file-earmark-text"></i> View Report
      </a>
      <a href="{{ url_for('manage_budgets') }}" class="btn btn-warning">
        <i class="bi bi-currency-dollar"></i> Manage Budgets
      </a>
    </div>
    {% endif %}

    <!-- Overview & Summary Cards -->
    <div class="row g-4">
      <!-- Overview -->
      <div class="col-md-4">
        <div class="card shadow-sm">
          <div class="card-header bg-primary text-white">
            <i class="bi bi-info-circle"></i> Overview
          </div>
          <div class="card-body">
            You are logged in as <strong>{{ user }}</strong>.
          </div>
        </div>
      </div>

      <!-- Budget Summary -->
      <div class="col-md-4">
        <div class="card shadow-sm">
          <div class="card-header bg-warning text-dark">
            <i class="bi bi-pie-chart"></i> Monthly Budget
          </div>
          <div class="card-body">
            <p><strong>Total Income:</strong> R{{ budget.income }}</p>
            <p><strong>Total Expenses:</strong> R{{ budget.expense }}</p>
            <p><strong>Limit:</strong> R{{ budget.limit }}</p>
            <p>
              <strong>Remaining:</strong>
              <span class="{% if budget.remaining<0 %}text-danger{% else %}text-success{% endif %}">
                R{{ budget.remaining }}
              </span>
            </p>
            {% if budget.remaining<0 %}
            <div class="alert alert-danger py-1 mt-2">
              ðŸš¨ Over budget by R{{ (budget.remaining * -1)|round(2) }}!
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Chart -->
      <div class="col-md-4">
        <div class="card shadow-sm">
          <div class="card-header bg-info text-white">
            <i class="bi bi-bar-chart-line"></i> Income vs Expense
          </div>
          <div class="card-body">
            <canvas id="incomeExpenseChart" height="200"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS + Icons + Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const ctx = document.getElementById('incomeExpenseChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: {{ chart_labels|tojson }},
        datasets: [{
            label: 'Income',
            data: {{ chart_income|tojson }},
            backgroundColor: 'rgba(40, 167, 69, 0.7)'
          },
          {
            label: 'Expense',
            data: {{ chart_expense|tojson }},
            backgroundColor: 'rgba(220, 53, 69, 0.7)'
          }
        ]
      },
      options: { responsive: true }
    });
  </script>
</body>
</html>
